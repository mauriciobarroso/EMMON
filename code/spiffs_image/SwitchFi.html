<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SwitchFi</title>
	<link href="https://images-na.ssl-images-amazon.com/images/I/71jKkXJr%2BwL.png" rel="icon" type="image/png" />
	<link href="https://images-na.ssl-images-amazon.com/images/I/71jKkXJr%2BwL.png" rel="apple-touch-icon" type="image/png" />
	<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
	<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<script>
		var direction_ip="192.168.1.108";
		var olddata;
		var newdata;
		var change_relays = 1;
	</script>
	<script>
		$(document).ready(function(){
			$(".relay").on("change",function(){
				if(change_relays==1){
					$("body").addClass("loading");
					$.get("http://"+direction_ip,{pin:$(this).attr("id")+""+$(this).val()},function(data){
						$("body").removeClass("loading");
					});	
				}
				change_relays=1;
			});
			$("#rst").click(function(){
				if(($("#1").val()==1)||($("#2").val()==1)||($("#3").val()==1)||($("#4").val()==1)){
					$("body").addClass("loading");
					change_relays=0;
					$("#1").val("0").flipswitch("refresh");
					change_relays=0;
					$("#2").val("0").flipswitch("refresh");
					change_relays=0;
					$("#3").val("0").flipswitch("refresh");
					change_relays=0;
					$("#4").val("0").flipswitch("refresh");
					$.get("http://"+direction_ip+"/resetall",function(data){
						$("body").removeClass("loading");
						change_relays=1;
					});		
				}
			});
			$("#checkbox-on-time").on("change",function(){
				if($(this).is(':checked')==true)	{$("#on-time").textinput("option",{disabled:false});}
				else	$("#on-time").textinput("option",{disabled:true})
			});
			$("#checkbox-off-time").on("change",function(){
				if($(this).is(':checked')==true)	{$("#off-time").textinput("option",{disabled:false});}
				else	$("#off-time").textinput("option",{disabled:true})
			});
			$("#checkbox-on-ilumination").on("change",function(){
				if($(this).is(':checked')==true)	{$("#on-ilumination").slider("option",{disabled:false});}
				else	$("#on-ilumination").slider("option",{disabled:true})
			});
			$("#checkbox-off-ilumination").on("change",function(){
				if($(this).is(':checked')==true)	{$("#off-ilumination").slider("option",{disabled:false});}
				else	$("#off-ilumination").slider("option",{disabled:true})
			});
			$("#select-relay").change(function(){
				var relay=$(this).children("option:selected").attr("value");
				$("body").addClass("loading");
				$.get("http://"+direction_ip,{relay},function(data){
					var string=data;
					newstring=string.split(",",7);
					$("#on-time").val(newstring[1]);
					$("#off-time").val(newstring[2]);
					$("#relay-name").val(newstring[3]);
					$("#on-ilumination").val(newstring[5]).slider("refresh");
					$("#off-ilumination").val(newstring[6]).slider("refresh");
					
					if((newstring[0]&0x01)==1){
						$("#checkbox-on-time").prop('checked',true).checkboxradio('refresh');
						$("#on-time").textinput("option",{disabled:false});
					}
					else{
						$("#checkbox-on-time").prop('checked',false).checkboxradio('refresh');
						$("#on-time").textinput("option",{disabled:true});
					}
					if(((newstring[0]>>1)&0x01)==1){
						$("#checkbox-off-time").prop('checked',true).checkboxradio('refresh');
						$("#off-time").textinput("option",{disabled:false});
					}
					else{
						$("#checkbox-off-time").prop('checked',false).checkboxradio('refresh');
						$("#off-time").textinput("option",{disabled:true});
					}
					if((newstring[4]&0x01)==1){
						$("#checkbox-on-ilumination").prop('checked',true).checkboxradio('refresh');
						$("#on-ilumination").slider("option",{disabled:false});
					}
					else{
						$("#checkbox-on-ilumination").prop('checked',false).checkboxradio('refresh');
						$("#on-ilumination").slider("option",{disabled:true});
					}
					if(((newstring[4]>>1)&0x01)==1){
						$("#checkbox-off-ilumination").prop('checked',true).checkboxradio('refresh');
						$("#off-ilumination").slider("option",{disabled:false});
					}
					else{
						$("#checkbox-off-ilumination").prop('checked',false).checkboxradio('refresh');
						$("#off-ilumination").slider("option",{disabled:true});
					}
					$("body").removeClass("loading");
				});
			});
			$("#save-nametime").click(function(){
				var timecheckboxes=($("#checkbox-on-time").prop("checked")&0x01)+(($("#checkbox-off-time").prop("checked")&0x01)<<0x01);
				var iluminationcheckboxes=($("#checkbox-on-ilumination").prop("checked")&0x01)+(($("#checkbox-off-ilumination").prop("checked")&0x01)<<0x01);
				newdata=$("#select-relay").val()+timecheckboxes+$("#on-time").val().replace(":","")+$("#off-time").val().replace(":","")+iluminationcheckboxes+$("#on-ilumination").val()+$("#off-ilumination").val()+$("#relay-name").val();
				olddata=$("#select-relay").val()+newstring[0]+newstring[1].replace(":","")+newstring[2].replace(":","")+newstring[3]+newstring[4]+newstring[5];
				if(newdata!=olddata){
					$("body").addClass("loading");
					$.get("http://"+direction_ip,{n:newdata},function(data){
						if($("#select-relay").val()==1)	$("#name1").text($("#relay-name").val());
						if($("#select-relay").val()==2)	$("#name2").text($("#relay-name").val());
						if($("#select-relay").val()==3)	$("#name3").text($("#relay-name").val());
						if($("#select-relay").val()==4)	$("#name4").text($("#relay-name").val());
						$("body").removeClass("loading");
						alert(data);
					});
				}
			});
			$("#save-ap-data").click(function(){
				newdata=$("#ap-ssid").val()+" "+$("#ap-pass").val();
				if($("#ap-ssid").val().length>1)	$.get("http://"+direction_ip,{ap:newdata},function(data){
					alert(data);
				});
			});
			$("#refresh-time").click(function(){
				function pad(str,max){
					str=str.toString();
					return str.length<max?pad("0"+str,max):str;
				}
				var nowtime=new Date();
				if(pad(nowtime.getHours(),2)+':'+pad((nowtime.getMinutes()+1),2)!=$("#times").val()){
					nowtime=pad(nowtime.getHours(),2)+''+pad((nowtime.getMinutes()+1),2);
					$("body").addClass("loading");
					$.get("http://"+direction_ip,{dt:nowtime},function(data){
						$("body").removeClass("loading");
						alert("Hora actualizada");
					});
					$("body").addClass("loading");
					$.get("http://"+direction_ip+"/time",function(data){
						$("#times").val(data);$("body").removeClass("loading");
					});
				}	
				else	alert("La hora ya est� actualizada");
			});
		});
		$(document).on("pagecreate","#relays",function(){
			//$("body").addClass("loading");
			setTimeout(function(){
				$.post("http://"+direction_ip+"/datainit",function(data){
					var datainitpic=data.split(",",5);
					if((datainitpic[0]&0x01)==1){
						change_relays=0;
						$("#1").val("1").flipswitch("refresh");
					}
					else	$("#1").val("0").flipswitch("refresh");
					if(((datainitpic[0]>>1)&0x01)==1){
						change_relays=0;
						$("#2").val("1").flipswitch("refresh");
					}
					else	$("#2").val("0").flipswitch("refresh");
					if(((datainitpic[0]>>2)&0x01)==1){
						change_relays=0;
						$("#3").val("1").flipswitch("refresh");
					}
					else	$("#3").val("0").flipswitch("refresh");
					if(((datainitpic[0]>>3)&0x01)==1){
						change_relays=0;
						$("#4").val("1").flipswitch("refresh");
					}
					else	$("#4").val("0").flipswitch("refresh");
					$("#name1").text(datainitpic[1]);
					$("#name2").text(datainitpic[2]);
					$("#name3").text(datainitpic[3]);
					$("#name4").text(datainitpic[4]);
					$("body").removeClass("loading");
				});
			},1000);
		});
		$(document).on("pagecreate","#auto",function(){
			$("#select-relay").val(1).change();
		});
		$(document).on("pagecreate","#time",function(){
			$("body").addClass("loading");
			$.get("http://"+direction_ip+"/time",function(data){
				$("#times").val(data);$("body").removeClass("loading");
			});
		});
	</script>
	<style>
		.ui-mobile label.labelfs{
			left:0 !important;
			float:left;
			margin-right:10px;
			margin-top:10px
		}
		.ui-flipswitch{float:right !important}
		.ui-page{background:#e9e9e9}
		.ui-field-contain>label~[class*=ui-], .ui-field-contain .ui-controlgroup-controls{margin:4px}.modal{
			display:none;position:fixed;
			z-index:1000;
			top:0;
			left:0;
			height:100%;
			width:100%;
			background:rgba( 255, 255, 255, .8 ) url('https://code.jquery.com/mobile/1.4.5/images/ajax-loader.gif') 50% 50% no-repeat
		}
		body.loading{overflow:hidden}
		body.loading .modal{display:block}
	</style>
</head>

<body>
	<div data-role="page" id="relays">
		<div data-role="header" data-position="fixed" data-theme="b">
			<h1>SwitchFi</h1>  
			<a href="#settings" class="ui-btn ui-btn-left ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-gear">Settings</a>
		</div>
		<div data-role="main" class="ui-content">
			<ul data-role="listview">
				<li class="ui-field-contain">
					<input type="button" value="Desactivar todos" id="rst" data-icon="power">
				</li>
				<li data-role="list-divider"></li>
				<li class="ui-field-contain">
					<label for="flip-1" class="labelfs" id="name1">Relay 1</label>
					<select name="flip-1" id="1" class="relay" data-role="flipswitch">
						<option value="0">Off</option>
						<option value="1">On</option>
					</select>
				</li>
				<li class="ui-field-contain">
					<label for="flip-2" class="labelfs" id="name2">Relay 2</label>
					<select name="flip-2" id="2" class="relay" data-role="flipswitch">
						<option value="0">Off</option>
						<option value="1">On</option>
					</select>
				</li>
				<li class="ui-field-contain">
					<label for="flip-3" class="labelfs" id="name3">Relay 3</label>
					<select name="flip-3" id="3" class="relay" data-role="flipswitch">
						<option value="0">Off</option>
						<option value="1">On</option>
					</select>
				</li>
				<li class="ui-field-contain">
					<label for="flip-4" class="labelfs" id="name4">Relay 4</label>
					<select name="flip-4" id="4" class="relay" data-role="flipswitch">
						<option value="0">Off</option>
						<option value="1">On</option>
					</select>
				</li>
			</ul>
		</div>
	</div>
	<div data-role="page" id="settings">
		<div data-role="header" data-position="fixed" data-theme="b">
			<h1>Ajustes</h1>  <a href="#relays" class="ui-btn ui-btn-left ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-back">Back</a>
		</div>
		<div data-role="main" class="ui-content">
			<ul data-role="listview" class="ui-alt-icon ui-nodisc-icon">
				<li data-role="list-divider">
					<h1>Configuracionn</h1>
				</li>
				<li><a href="#access-point">Wi-Fi</a>
				</li>
				<li><a href="#time">Hora</a>
				</li>
				<li><a href="#auto">Relays</a>
				</li>
			</ul>
		</div>
	</div>
	<div data-role="page" id="access-point">
		<div data-role="header" data-position="fixed" data-theme="b">
			<h1>Access Point</h1>  <a href="#settings" class="ui-btn ui-btn-left ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-back">Back</a>  <a class="ui-btn ui-btn-right ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-check" id="save-ap-data">Save</a>
		</div>
		<div data-role="main" class="ui-content">
			<ul data-role="listview" class="ui-alt-icon ui-nodisc-icon">
				<li data-role="list-divider">
					<p>Ingrese el SSID y el PASSWORD de la red Wi-Fi a la que quiera conectarse.</p>
				</li>
				<li>
					<form>
						<label for="ap-ssid">SSID:</label>
						<input type="text" data-clear-btn="true" name="ap-ssid" id="ap-ssid" value="" autocomplete="off" maxlength="8" class="input-ap">
						<label for="ap-pass">Password:</label>
						<input type="text" data-clear-btn="true" name="ap-pass" id="ap-pass" value="" autocomplete="off" maxlength="8" class="input-ap">
					</form>
				</li>
			</ul>
		</div>
	</div>
	<div data-role="page" id="time">
		<div data-role="header" data-position="fixed" data-theme="b">
			<h1>Hora</h1>  <a href="#settings" class="ui-btn ui-btn-left ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-back">Back</a>
			<a class="ui-btn ui-btn-right ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-refresh" id="refresh-time">Refresh</a>
		</div>
		<div data-role="main" class="ui-content">
			<ul data-role="listview" class="ui-alt-icon ui-nodisc-icon">
				<li data-role="list-divider">
					<h1></h1>
				</li>
				<li class="ui-field-contain">
					<input type="time" id="times" disabled>
				</li>
			</ul>
		</div>
	</div>
	<div data-role="page" id="auto">
		<div data-role="header" data-position="fixed" data-theme="b">
			<h1>Automatizacion</h1>  <a href="#settings" class="ui-btn ui-btn-left ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-back">Back</a>  <a class="ui-btn ui-btn-right ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-check" id="save-nametime">Save</a>
		</div>
		<div data-role="main" class="ui-content">
			<ul data-role="listview" class="ui-alt-icon ui-nodisc-icon">
				<li data-role="list-divider">
					<h1></h1>
				</li>
				<li class="ui-field-contain">
					<form>
						<select name="select-relay" id="select-relay">
							<option value="1" id="option-name1">Relay 1</option>
							<option value="2" id="option-name2">Relay 2</option>
							<option value="3" id="option-name3">Relay 3</option>
							<option value="4" id="option-name4">Relay 4</option>
						</select>
						<input type="text" name="relay-name" id="relay-name" placeholder="Nombre" maxlength="8">
						<label for="checkbox-on-time">Hora de encendido</label>
						<input type="checkbox" name="checkbox-on-time" id="checkbox-on-time">
						<input type="time" name="on-time" id="on-time" disabled>
						<label for="checkbox-off-time">Hora de apagado</label>
						<input type="checkbox" name="checkbox-off-time" id="checkbox-off-time">
						<input type="time" name="off-time" id="off-time" disabled>
						<label for="checkbox-on-ilumination">Encendido por iluminacón</label>
						<input type="checkbox" name="checkbox-on-ilumination" id="checkbox-on-ilumination">
    					<input type="range" name="on-ilumination" id="on-ilumination" data-highlight="true" min="1" max="9" value="50" disabled>
						<label for="checkbox-off-ilumination">Apagado por iluminacón</label>
						<input type="checkbox" name="checkbox-off-ilumination" id="checkbox-off-ilumination">
    					<input type="range" name="off-ilumination" id="off-ilumination" data-highlight="true" min="1" max="9" value="50" disabled>
					</form>
				</li>
			</ul>
		</div>
	</div>
	<div class="modal"></div>
</body>

</html>